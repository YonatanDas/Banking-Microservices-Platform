apiVersion: kyverno.io/v1
kind: ClusterPolicy
metadata:
  name: require-semantic-version
  annotations:
    policies.kyverno.io/title: Require Semantic Version Tags
    policies.kyverno.io/category: Image Verification
    policies.kyverno.io/severity: medium
    policies.kyverno.io/subject: Pod,Deployment,StatefulSet,DaemonSet,Job,CronJob
    policies.kyverno.io/description: >-
      Prevents use of mutable tags like 'latest', 'dev', 'main', or 'master'.
      Allows semantic versioning (v*.*.*) or numeric build numbers (1, 2, 3...)
      to ensure reproducible deployments and prevent accidental rollbacks.
spec:
  validationFailureAction: Enforce
  background: true
  rules:
    - name: check-image-tag
      match:
        any:
          - resources:
              kinds:
                - Pod
                - Deployment
                - StatefulSet
                - DaemonSet
                - Job
                - CronJob
      validate:
        cel:
          expressions:
            - expression: |
                object.spec.containers.all(c, 
                  !c.image.matches('.*:(latest|dev|main|master)$') &&
                  !c.image.matches('.*:.*dev.*') &&
                  !c.image.matches('.*:.*test.*')
                ) &&
                (!has(object.spec.initContainers) || 
                  object.spec.initContainers.all(c,
                    !c.image.matches('.*:(latest|dev|main|master)$') &&
                    !c.image.matches('.*:.*dev.*') &&
                    !c.image.matches('.*:.*test.*')
                  ))
              message: "Image tag cannot be 'latest', 'dev', 'main', 'master', or contain 'dev'/'test'. Use semantic version (v1.0.0) or numeric build number (e.g., 20)."
      exclude:
        any:
          - resources:
              namespaces:
                - kube-system
                - kyverno
                - argocd
                - external-secrets


apiVersion: monitoring.coreos.com/v1
kind: PrometheusRule
metadata:
  name: banking-app-application-alerts
  namespace: monitoring
  labels:
    app: banking-app
    prometheus: kube-prometheus
spec:
  groups:
    - name: application_alerts
      interval: 30s
      rules:
        # High HTTP Error Rate
        - alert: HighHTTPErrorRate
          expr: |
            sum(rate(http_server_requests_seconds_count{status=~"5.."}[5m])) by (service, namespace) / 
            sum(rate(http_server_requests_seconds_count[5m])) by (service, namespace) > 0.05
          for: 5m
          labels:
            severity: critical
          annotations:
            summary: "High HTTP error rate for {{ $labels.service }}"
            description: "Service {{ $labels.service }} in namespace {{ $labels.namespace }} has error rate above 5% for more than 5 minutes."

        # High Request Latency
        - alert: HighRequestLatency
          expr: |
            histogram_quantile(0.99, sum(rate(http_server_requests_seconds_bucket[5m])) by (le, service, namespace)) > 1
          for: 5m
          labels:
            severity: warning
          annotations:
            summary: "High request latency for {{ $labels.service }}"
            description: "Service {{ $labels.service }} in namespace {{ $labels.namespace }} has 99th percentile latency above 1 second for more than 5 minutes."

        # Service Down
        - alert: ServiceDown
          expr: up{job=~"accounts|cards|loans|gateway"} == 0
          for: 5m
          labels:
            severity: critical
          annotations:
            summary: "Service {{ $labels.job }} is down"
            description: "Service {{ $labels.job }} has been down for more than 5 minutes."

